name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Verify tag matches package version
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          PKG_VERSION=$(python -c "
          import re
          with open('pyproject.toml') as f:
              for line in f:
                  m = re.match(r'^version\s*=\s*\"(.+)\"', line)
                  if m:
                      print(m.group(1))
                      break
          ")
          if [ "$TAG" != "$PKG_VERSION" ]; then
            echo "Error: tag v$TAG does not match pyproject.toml version $PKG_VERSION"
            exit 1
          fi
          echo "Version check passed: v$TAG == $PKG_VERSION"

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - name: Install package with dev dependencies
        run: pip install -e ".[dev]"
      - name: Lint
        run: |
          ruff check src/ tests/
          ruff format --check src/ tests/
      - name: Run tests
        run: pytest tests/ -v --tb=short --cov=nnunet_tracker --cov-fail-under=80

  publish:
    needs: [validate, test]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install build tools
        run: pip install build
      - name: Build package
        run: python -m build
      - name: Verify wheel
        run: |
          pip install dist/*.whl
          python -c "import nnunet_tracker; print(nnunet_tracker.__version__)"
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
